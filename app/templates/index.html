{% extends "base.html" %}

{% block content %}
    {% import 'macros/breadcrumb.html' as breadcrumb_macros %}
    {% import 'macros/pagination.html' as pagination_macros %}

    {% if selected_category %}
        <div class="category-row-content mb-3">
            {{ breadcrumb_macros.breadcrumb(selected_category) }}
            <h2 class="mt-3 mb-3">{{ selected_category.name }}</h2>
        </div>
    {% endif %}

    {# Check if this is the index page (carousels) or a category page (grid) #}
    {% if category_carousels is defined %}
        {# INDEX PAGE: Display carousels #}
        {% if not any_categories_exist %}
            {# No categories exist at all #}
            <div class="category-row-content">
                <div class="alert alert-warning alert-heading mb-4">
                    No categories available. Please contact the administrator to add categories.
                </div>
            </div>
        {% elif category_carousels|length == 0 %}
            {# Categories exist but none have listings #}
            <div class="category-row-content">
                <p class="alert alert-info alert-heading mb-4">No listings found.</p>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('listings.create_listing') }}" class="btn btn-success mb-4">+ Post New Listing</a>
                {% endif %}
            </div>
        {% else %}
            {# Display "+ Post New Listing" button only when categories exist #}
            {% if current_user.is_authenticated %}
                <div class="category-row-content">
                    <a href="{{ url_for('listings.create_listing') }}" class="btn btn-success mb-4">+ Post New Listing</a>
                </div>
            {% endif %}

            {# Render showcase rows for each category #}
            {% for carousel_item in category_carousels %}
                <div class="category-row-section mb-5">
                    <div class="category-row-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">
                                {% if carousel_item.category.name.startswith('Other ') %}
                                    <a href="{{ url_for('listings.category_filtered_listings', category_path=carousel_item.category.url_path, view='listings') }}" class="text-decoration-none category-title-link">
                                        {{ carousel_item.category.name }}
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('listings.category_filtered_listings', category_path=carousel_item.category.url_path) }}" class="text-decoration-none category-title-link">
                                        {{ carousel_item.category.name }}
                                    </a>
                                {% endif %}
                            </h3>
                            {% if carousel_item.category.name.startswith('Other ') %}
                                <a href="{{ url_for('listings.category_filtered_listings', category_path=carousel_item.category.url_path, view='listings') }}" class="text-decoration-none see-all-link">
                                    <span class="see-all-text">See all </span>→
                                </a>
                            {% else %}
                                <a href="{{ url_for('listings.category_filtered_listings', category_path=carousel_item.category.url_path) }}" class="text-decoration-none see-all-link">
                                    <span class="see-all-text">See all </span>→
                                </a>
                            {% endif %}
                        </div>

                        <div class="category-showcase-container">
                            <div class="d-flex gap-4">
                            {% for listing in carousel_item.listings %}
                                <div class="flex-shrink-0" style="width: 192px;">
                                    <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}" class="text-decoration-none text-reset">
                                        <div class="card card-dimensions">
                                            <img src="{{
                                                      url_for('static', filename=('uploads/thumbnails/' ~ listing.images[0].thumbnail_filename
                                                      if listing.images and listing.images[0].thumbnail_filename
                                                      else 'img/no-image-thumbnail.png'))
                                                      }}"
                                                 class="card-img-top card-img-top-fit"
                                                 alt="{{ listing.title }}"
                                            >

                                            <div class="card-body">
                                                <h6 class="card-title mb-2">{{ listing.title }}</h6>
                                                <h5 class="card-subtitle fw-bold">
                                                    {% if listing.price %}
                                                        ${{ "%.2f"|format(listing.price) }}
                                                    {% else %}
                                                        Free
                                                    {% endif %}
                                                </h5>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% else %}
        {# CATEGORY PAGE: Display grid layout (original code) #}
        {% if current_user.is_authenticated %}
            <div class="category-row-content">
                <a href="{{ url_for('listings.create_listing') }}" class="btn btn-success mb-4">+ Post New Listing</a>
            </div>
        {% endif %}

        {% if listings|length == 0 %}
            <div class="category-row-content">
                <p class="alert alert-info alert-heading mb-4">No listings found.</p>
            </div>
        {% else %}
            <div class="category-row-content">
                <div class="row row-cols-xxl-5 row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-1 g-4 mb-4">
                    {% for listing in listings %}
                        <div class="col d-flex justify-content-center">
                            <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}" class="text-decoration-none text-reset">
                                <div class="card card-dimensions">
                                    <img src="{{
                                              url_for('static',filename=('uploads/thumbnails/' ~ listing.images[0].thumbnail_filename
                                              if listing.images and listing.images[0].thumbnail_filename
                                              else 'img/no-image-thumbnail.png'))
                                              }}"
                                         class="card-img-top card-img-top-fit"
                                         alt="{{ listing.title }}"
                                    >

                                    <div class="card-body">
                                        <h6 class="card-title mb-2">{{ listing.title }}</h6>
                                        <h5 class="card-subtitle fw-bold">
                                            {% if listing.price %}
                                                ${{ "%.2f"|format(listing.price) }}
                                            {% else %}
                                                Free
                                            {% endif %}
                                        </h5>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {{ pagination_macros.render_pagination(pagination, 'listings.index', sort=sort, direction=direction) }}
    {% endif %}

{% endblock %}
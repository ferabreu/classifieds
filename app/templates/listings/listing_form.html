{#
  Template written and annotated by GitHub Copilot at the request of Fernando "ferabreu" Mees Abreu.
  See LICENSE file in the project root for full license information.

  Listing creation and edit form. Allows users to create and modify listings with title, description, price, category, and images.
#}

{% extends "base.html" %}

{% block content %}
    <div class="category-row-content">
        <form method="POST" enctype="multipart/form-data">

            {{ form.hidden_tag() }}

            <div class="mb-3">
                {% for field, errors in form.errors.items() %}
                    {% for error in errors %}
                        <div class="alert alert-danger">{{ field }}: {{ error }}</div>
                    {% endfor %}
                {% endfor %}
            </div>

            <div class="mb-3">
                {{ form.title.label(class="form-label") }}
                {{ form.title(class="form-control", placeholder="Listing title") }}
                {% for error in form.title.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="mb-3">
                {{ form.description.label(class="form-label") }}
                {{ form.description(class="form-control", placeholder="Listing description") }}
                {% for error in form.description.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="row g-3 mb-3 align-items-start">
                <div class="col-md-8">
                    <div id="category-dropdowns-label">{{ form.category.label(class="form-label") }}</div>
                    {{ form.category(class="form-select", id="category", style="display:none;") }}
                    <div id="category-dropdowns"
                         data-hidden-field-id="category"
                         data-subcategories-url="{{ url_for('categories.api_children', parent_id=0) | replace('0','{parent_id}') }}"
                         data-breadcrumb-url="{{ url_for('categories.api_breadcrumb', category_id=0) | replace('0','{category_id}') }}"></div>
                    {% for error in form.category.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-md-4">
                    {{ form.price.label(class="form-label") }}
                    {{ form.price(class="form-control", placeholder="Price") }}
                    {% for error in form.price.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>

            {% if listing %}
                <div class="row">
                    {% for image in listing.images %}
                        <div class="col-auto mb-2 text-center">
                            <a href="{{ url_for('static', filename='uploads/' ~ image.filename) }}" target="_blank">
                                <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}"
                                     alt="Listing image"
                                     class="img-thumbnail"
                                     style="max-width: 120px; max-height: 120px;">
                            </a>
                            <div>
                                <label>
                                    <input type="checkbox" name="delete_images" value="{{ image.id }}">
                                    Delete
                                </label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="mb-3">
                {{ form.images.label(class="form-label") }}
                {{ form.images(class="form-control", multiple=True) }}
                {% for error in form.images.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/category_dropdowns.js') }}"></script>
{% endblock %}